<!DOCTYPE html>
<html lang="ja">
	<head>
		<meta charset="shift_jis">
		<title>PayPay銀行　お問い合わせ一覧画面</title>
		<meta name="description" content="顧客コンタクトボード">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <style>
            /*contactboardContents*/
            #contact .contbrd-title{margin:0 0 16px;border-radius:8px;padding:8px;background-color:#606060;color:#ffffff;text-align:center;}
            /*contactboard*/
            #contact .contbrd-head{position:relative;margin-bottom:16px;}
            #contact .contbrd-head::before{content:"";display:inline-block;width:64px;height:64px;margin:0 16px 0 0;background-size:contain;}
            #contact .contbrd-head.customer::before{background:transparent url(/commontpl/images/category/contact_ic001.svg) no-repeat center center;}
            #contact .contbrd-head.answer::before{background:transparent url(/commontpl/images/category/contact_ic002.svg) no-repeat center center;}
            #contact .contbrd-wrap .contbrd-cont{padding:24px 0;border-bottom:1px solid #bababa;}
            #contact .contbrd-wrap .contbrd-cont:first-of-type{padding-top:0;}
            #contact .contbrd-wrap .contbrd-cont:last-of-type{border-bottom:none;}
            #contact .contbrd-wrap .contbrd-cont dl{position:absolute;display:inline-block;width:72%;top:8px;}
            #contact .contbrd-wrap .contbrd-cont dl dt{color:#606060;display:flex;justify-content:space-between;}
            #contact .contbrd-wrap .contbrd-cont dl dt .new-icon{width:46px;height:18px;margin-left:5px;border-radius:15px;background-color:#ffb900;color:#ffffff;text-align:center;font-size:1.2rem;}
            #contact .contbrd-wrap .contbrd-cont dl dd{margin:6px 0;color:#606060;}
            #contact .contbrd-wrap .contbrd-cont dl dd::before{content:"";display: inline-block;width:20px;height:20px;margin:0 11px 0 0;background:transparent url(/commontpl/images/category/contact_ic003.svg) no-repeat center center;background-size:contain;vertical-align:top;}
            #contact .contbrd-body{position:relative;}
            #contact .contbrd-body::after{content:"";width:8px;height:8px;border:0px;border-right:2px solid #bababa;border-top:2px solid #bababa;transform:rotate(135deg);position:absolute;top:5px;right:0.5em;}
            #contact .contbrd-body.first::after{display:none;}
            #contact .contbrd-body.first .contbrd-txt,#contact .contbrd-cont.open .contbrd-body.first .contbrd-txt{width:100%;}
            #contact .contbrd-cont.open .contbrd-body::after{transform:rotate(-45deg);}
            #contact .contbrd-txt p{display:none;}
            #contact .contbrd-txt,#contact .contbrd-txt p:first-of-type{width:90%;-webkit-line-clamp:1;display:-webkit-box;-webkit-box-orient:vertical;overflow:hidden;}
            #contact .contbrd-body.first .contbrd-txt,#contact .contbrd-body.first .contbrd-txt p,#contact .contbrd-cont.open .contbrd-txt,#contact .contbrd-cont.open .contbrd-txt p:first-of-type,#contact .contbrd-cont.open .contbrd-txt p{-webkit-line-clamp:unset;display:block;}
            #contact .contbrd-cont.open .contbrd-txt,#contact .contbrd-cont.open .contbrd-txt p:first-of-type,#contact .contbrd-cont.open .contbrd-txt p{width:95%;}
            #contact .contbrd-txt + .h301{padding-top:16px; /*追加display:none;/追加*/}
        </style>
	</head>
	<body>
        <!--template-->
        <template id="contbrdTemplate">
            <div class="contbrd-cont">
                <div class="contbrd-head">
                    <dl>
                        <dt><span class="actor-type"></span></dt>
                        <dd class="date-time"></dd>
                    </dl>
                </div>
                <div class="contbrd-body">
                    <div class="contbrd-txt"><p class="contbrd-p"></p></div>
                </div>
            </div>
        </template>
        <!--/template-->
        <!--fileTemplate-->
        <template id="fileTemplate">
            <h3 class="h301">ファイル</h3>
            <p><a class="contbrd-file" href=""></a></p>
        </template>
        <!--fileTemplate-->
        

        <!--contents-->
        <p id="contbrdTitle" class="contbrd-title"></p>

        <!--output_template-->
        <div id="outputContbrd" class="contbrd-wrap">
        </div>
        <!--/output_template-->

        <!--/contents-->
        
        <script type="text/javascript">
            /*** 
             * SFから取得した日付をJSTに変換して、フォーマットにはめて返却
             * 引数　：2022-06-06T04:43:08.000+0000
             * 返却値：2022年06月06日 04:43
             ***/
            function changeDate(dateTime){
                const newDate = new Date(dateTime);
                const year = newDate.getFullYear();
                const month = newDate.getMonth() + 1;
                const day = newDate.getDate();
                const hour = (`0` + (newDate.getHours())).slice(-2)
                const minute = (`0` + (newDate.getMinutes())).slice(-2)
                return `${year}年${month}月${day}日 ${hour}:${minute}`;
            }
            
            // responseを受け取るリスト
            let vdList = [];
            // 初期表示処理
            window.onload = function(){
                let caseNum = '00001056';
                // タイトル
                let title = document.getElementById('contbrdTitle');
                title.innerHTML = 'お問い合わせ番号：No.' + caseNum;
                // アクセストークン取得（リフレッシュトークンフロー） Ajax
                $.ajax({
                    type: 'POST',
                    crossOrigin: true,
                    url: 'https://protocomdev-dev-ed.my.salesforce.com/services/oauth2/token',
                    dataType: 'json',
                    cache :false,
                    data : {"grant_type":"refresh_token","client_id":"3MVG9pRzvMkjMb6nsLsmTx_FqB0rQ9AHEMYt85TrwFp6b3yeP.ta18VQpmha_Ds31fssFdYib4DdLPcLKqtQG", "client_secret":"F864BDD8ADFB8B17EA27F0623CF9039A503A76F9312032654DBFFDB25E87B142","refresh_token":"5Aep861mdLLi91HqFfCpXYtQXRaOgcHsK1gi36_cVHboubUhDFRrSCX9zyL1KBPgaR5qiKjUA54Q0RZhiN_teRI"},
                    success : function (connectData) {
                        // アクセストークン
                        let accToken = 'Bearer ' + connectData.access_token;
                        // コンタクトボード明細取得
                        $.ajax({
                            type: 'GET',
                            crossOrigin: true,
                            url: 'https://protocomdev-dev-ed.my.salesforce.com/services/apexrest/Mock_File/' + caseNum,
                            dataType: 'json',
                            cache :false,
                            headers: {"Authorization" : accToken},
                            data : JSON.stringify(caseNum),
                            success : function (res) {
                                console.log(res);
                                // ファイルの中身を格納する配列を定義
                                let versionDataArray = [];
                                vdList = res;
                                // ファイルのId(ファイルの件数確認用)
                                let cvIdList = vdList.map(el => el.contentVersionIdList);
                                // nullを削除
                                cvIdList = cvIdList.filter(el => el);
                                const promise = new Promise((resolve) => {
                                    // データを取得できた場合
                                    if(vdList.length != 0){
                                        let count = 0;
                                        // ファイルを取得（処理が順不同）
                                        for(let i = 0; i < vdList.length; i++){
                                            if(vdList[i].contentVersionIdList){
                                                $.ajax({
                                                    type: 'GET',
                                                    crossOrigin: true,
                                                    url: 'https://protocomdev-dev-ed.my.salesforce.com/services/data/v54.0/sobjects/ContentVersion/' + vdList[i].contentVersionIdList + '/VersionData',
                                                    cache :false,
                                                    headers: {"Authorization" : accToken},
                                                    xhrFields : {responseType : 'blob'},
                                                    success : function (dlFile) {
                                                        // URL生成
                                                        let binaryData = [];
                                                        binaryData.push(dlFile);
                                                        let fileUrl = URL.createObjectURL(new Blob(binaryData, {type: "application/octet-stream"}));
                                                        versionDataArray.push({
                                                            cvId: vdList[i].contentVersionIdList, 
                                                            cvName: vdList[i].fileNameList, 
                                                            versionData: fileUrl
                                                        });
                                                        count++;
                                                        /*console.log(versionDataArray);
                                                        console.log('i : ' + i);
                                                        console.log('count : ' + count);
                                                        console.log('cvIdList.length : ' + cvIdList.length);
                                                        console.log(count == cvIdList.length);*/
                                                        
                                                        // ファイルのIdの件数分動いたらresolve
                                                        if(count == cvIdList.length){
                                                            console.log('resolve');
                                                            resolve();
                                                        }
                                                    }
                                                })
                                            }
                                        }
                                    }
                                // promiseがresolveしたら実行
                                }).then(() => {
                                    /*** タグの生成 ***/
                                    console.log('タグの生成');
                                    // template要素を取得
                                    let template = document.getElementById('contbrdTemplate');
                                    // ファイルのtemplate要素を取得
                                    let templateFile = document.getElementById('fileTemplate');
                                    // コンタクトボード明細の数分繰り返し
                                    for(let j = 0; j < vdList.length; j++){
                                        // template要素の内容を複製
                                        let clone = template.content.cloneNode(true);
                                        // 返信内容が12 文字以下ならそのまま、それを超える場合省略
                                        /*let content = vdList[j].cbd.RecordType__c + ':' + vdList[j].cbd.Content__c;
                                        if(content.length > 12){
                                            content = content.substring(0, 12) + "...";
                                        }*/
                                        // 複製したtemplate要素にデータを挿入
                                        // クローン初回のみ
                                        if(j == 0){
                                            // 全表示
                                            clone.querySelector('.contbrd-body').calss = 'contbrd-body first';
                                        }
                                        clone.querySelector('.actor-type').innerHTML = 'お客様';
                                        clone.querySelector('.date-time').innerHTML = changeDate(vdList[j].cbd.CreatedDate);
                                        clone.querySelector('.contbrd-p').innerHTML = vdList[j].cbd.RecordType__c + ':' + vdList[j].cbd.Content__c;
                                        // 追加先用のidを追加
                                        clone.querySelector('.contbrd-body').id = 'contbrdBody' + j;

                                        // div#containerの中に追加
                                        document.getElementById('outputContbrd').appendChild(clone);
                                        // クローン回数カウント
                                        let c = 0;
                                        // ファイルの数分繰り返し
                                        for(let k = 0; k < versionDataArray.length; k++){
                                            if(vdList[j].contentVersionIdList == versionDataArray[k].cvId){
                                                // template要素の内容を複製
                                                let cloneFile = templateFile.content.cloneNode(true);
                                                // 複製したtemplate要素にデータを挿入
                                                // クローン初回のみ
                                                /*if(c == 0){
                                                    // 固定文字を表示
                                                    cloneFile.querySelector('.h301').style.display = 'inline';
                                                }*/
                                                // ファイル
                                                cloneFile.querySelector('.contbrd-file').innerText = versionDataArray[k].cvName;
                                                cloneFile.querySelector('.contbrd-file').download = versionDataArray[k].cvName;
                                                cloneFile.querySelector('.contbrd-file').href = versionDataArray[k].fileUrl;
                                                // div#containerの中に追加
                                                document.getElementById('contbrdBody' + j).appendChild(cloneFile);
                                                // クローン回数をインクリメント
                                                c++;
                                            }
                                        }
                                    }
                                    /*** //タグの生成 ***/
                                });
                            },
                            error : function (data, errorThrown,status) {
                                
                            }
                        })
                    },
                    error : function (data, errorThrown,status) {
                    }
                });
                
            }





            // 引数：ケースNo
            function sendCbd(caseNum){
                
            }
        </script>
    </body>
</html>