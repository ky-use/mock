<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="ja">
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta http-equiv="Content-Type" content="text/html; charset=shift_jis">
		<meta http-equiv="Content-Script-Type" content="text/javascript">
		<meta name="format-detection" content="telephone=no">

		<title>お問い合わせフォーム</title>

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	</head>

	<body id="contact">
		
		<div>
			<a id="link"></a>
		</div>
		
		<script type="text/javascript">

		// 通信先URL　※環境に併せて変更する必要あり！
		const REQUEST_DOMAIN = 'https://paypay-bank--pt49.sandbox.my.salesforce.com';

		$(function(){
				// アクセストークン取得（リフレッシュトークンフロー） Ajax
			$.ajax({
				type: 'POST',
				crossOrigin: true,
				url: REQUEST_DOMAIN + '/services/oauth2/token',
				dataType: 'json',
				cache :false,
				data : {
					"grant_type":"refresh_token",
					"client_id":"3MVG99S6MzYiT5k.KkcZzmtcXubr_J8l8N8473VR.oFizQeVyWXFV5ARIiXmwhmXqjuNU.K6Pk9mc9M3btLBQ", 
					"refresh_token":"5Aep861hjC52juQoBcsFRsbEALR2k2PEkuCJTzezJjsxYDFcfM3Xu_8fN.OBDlZ6BJFv9GwwXc8hH5doNmlIiVu"
				},
				success : function (connectData) {
					var accToken = 'Bearer ' + connectData.access_token;
					$.ajax({
						type: 'GET',
						crossOrigin: true,
						url: REQUEST_DOMAIN + '/services/apexrest/IMF_Case',
						dataType: 'json',
						cache :false,
						data: {inquiry : 'd5b8d90ceb5ff5f3505dd311e1e74f6e3f87d028ddac9c3c4c18ede46409e0ef'},
						headers: {"Authorization" : accToken},
						success : function (res) {
							console.log('res:'+ JSON.stringify(res));
							//return res;
							if(!res.caseList){
								console.log('!res.caseList');
							}else{
								console.log('else');
							}

							let fileId = '0680l000002QlbNAAS';

							// ファイル取得
							$.ajax({
								type: 'POST',
								crossOrigin: true,
								url: REQUEST_DOMAIN + '/services/oauth2/token',
								dataType: 'json',
								cache :false,
								data : {
									"grant_type":"refresh_token",
									"client_id":"3MVG99S6MzYiT5k.KkcZzmtcXubr_J8l8N8473VR.oFizQeVyWXFV5ARIiXmwhmXqjuNU.K6Pk9mc9M3btLBQ", 
									"refresh_token":"5Aep861hjC52juQoBcsFRsbEALR2k2PEkuCJTzezJjsxYDFcfM3Xu_8fN.OBDlZ6BJFv9GwwXc8hH5doNmlIiVu"
								},
								success : function (connectData) {
									var accToken = 'Bearer ' + connectData.access_token;
									$.ajax({
										type: 'GET',
										crossOrigin: true,
										url: REQUEST_DOMAIN + '/services/data/v54.0/sobjects/ContentVersion/' + fileId + '/VersionData',
										cache :false,
										headers: {"Authorization" : accToken},
										xhrFields : {responseType : 'blob'},
										success : function (fileContent) {
											console.log(JSON.stringify(fileContent))
											let fileUrl = URL.createObjectURL(new Blob(
												[fileContent],
												{type: "application/octet-stream"}
											));
											document.getElementById('link').href = fileUrl;
											document.getElementById('link').download = fileUrl;
											document.getElementById('link').innerHTML = fileUrl;
										}
									})
								},
								error : function (data, errorThrown,status) {
									console.log(data);
									console.log(errorThrown);
									console.log(status);
								}
							});
						},
						error : function (data, errorThrown,status) {

						}
					})
				},
				error : function (data, errorThrown,status) {
					console.log(data);
					console.log(errorThrown);
					console.log(status);
				}
			});
		});

		function getContentVersion(fileId){


		}
		</script>
	</body>
</html>
