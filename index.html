<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="ja">
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta http-equiv="Content-Type" content="text/html; charset=shift_jis">
		<meta http-equiv="Content-Script-Type" content="text/javascript">
		<meta name="format-detection" content="telephone=no">

		<title>お問い合わせフォーム</title>

		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <style>
            #contact .modalOverlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:102;overflow:auto;background-color:rgba(0, 0, 0, 0.6);}
            #contact .modalWrap,#contact .modalWrap_error{display:none;position:fixed;top:0;left:0;z-index:103;width:100%;height:100%;}
            #contact .modalOuter,#contact .modalOuter_error{z-index:104;background-color:#fff;border-radius:8px;position:relative;margin:16px;padding-bottom:24px;}
            #contact .modal__headArea{padding:16px 24px;font-size:14px;font-weight:bold;text-align:center;}
            #contact .modal__bodyArea{margin-bottom:16px;padding:0 24px;overflow:auto;}
            #contact .modalOuter_error{top:27%;margin-top:-8%;}
            #contact .modalWrap_error .modal__bodyArea{font-size:1.6rem;text-align:center;}
            #contact .modal_error_btnArea{padding:0 16px;}
            #contact .modal_error_btnArea p:last-of-type{margin-top:16px;}
        </style>
	</head>
	
	<!-- cbdTemplate -->
	<template id="cbdTemplate">
		<div class="contbrd-cont">
			<div class="contbrd-head">
				<dl>
				<dt><span class="actor-text"></span><div class="outputNew list-qa-box"></div></dt>
				<dd class="createddate"></dd>
				</dl>
			</div>
			<div class="contbrd-body">
				<div id="" name="cbdId" class="contbrd-txt">
					<p class="contbrd-content"></p>
				</div>
			</div>
		</div>
	</template>
	<!-- cbdTemplate -->

	<!-- fileTemplate -->
	<template id="fileTemplate">
		<p><a class="fileLink"></a></p>
	</template>
	<!-- fileTemplate -->
	
	<body id="contact">
		
		<div>
			<a id="link"></a>
		</div>
		
		<div id="outputCbdTemp">					
		</div>
        <div class="modalOverlay"></div>

		<button onclick="responseApexData();">登録</button>
		<button onclick="newinq();">新規画面</button>
	
        
        <div class="modalWrap_error error-comError">
            <div class="modalOuter_error">
                <div class="modal__headArea"><img src="commontpl/images/category/contact_error.png" alt="" width="128" height="64"></div>
                <div class="modal__bodyArea">
                    <p class="fBold">通信エラーが発生しました。<br>時間をおいて、再度お試しください。</p>
                </div><!--/modal__bodyArea-->
                <div class="modal_error_btnArea">
                    <p><a href="javascript:void(0);" class="btn btn03 btnL mClose">閉じる</a></p>
                </div><!--/modal_error_btnArea-->
            </div><!--/modalOuter_error-->
        </div><!--/modalWrap_error-->


        <div class="modalWrap_error error-timeoutError">
            <div class="modalOuter_error">
                <div class="modal__headArea"><img src="commontpl/images/category/contact_error.png" alt="" width="128" height="64"></div>
                <div class="modal__bodyArea">
                    <p class="fBold">ログイン後、一定の時間が経過しました。<br>再度ログインしてご利用ください。</p>
                </div><!--/modal__bodyArea-->
                <div class="modal_error_btnArea">
                    <p><a href="javascript:void(0);" class="btn btn03 btnL mClose">閉じる</a></p>
                </div><!--/modal_error_btnArea-->
            </div><!--/modalOuter_error-->
        </div><!--/modalWrap_error-->
        
        <div class="modalWrap_error error-abnormalError">
            <div class="modalOuter_error">
                <div class="modal__headArea"><img src="commontpl/images/category/contact_error.png" alt="" width="128" height="64"></div>
                <div class="modal__bodyArea">
                    <p class="fBold">システムエラーが発生しました。<br>時間をおいて、再度ログインしてご利用ください。</p>
                </div><!--/modal__bodyArea-->
                <div class="modal_error_btnArea">
                    <p><a href="javascript:void(0);" class="btn btn03 btnL mClose">閉じる</a></p>
                </div><!--/modal_error_btnArea-->
            </div><!--/modalOuter_error-->
        </div><!--/modalWrap_error-->
        
        <div class="modalWrap_error error-nocaseError">
            <div class="modalOuter_error">
                <div class="modal__headArea"><img src="commontpl/images/category/contact_error.png" alt="" width="128" height="64"></div>
                <div class="modal__bodyArea">
                    <p class="fBold">ただいまお客さま情報を登録中です。<br>登録が完了しましたら<br>お問い合わせ可能となりますので、<br>時間をおいて再度お試しください。</p>
                </div><!--/modal__bodyArea-->
                <div class="modal_error_btnArea">
                    <p><a href="javascript:void(0);" class="btn btn03 btnL mClose">閉じる</a></p>
                </div><!--/modal_error_btnArea-->
            </div><!--/modalOuter_error-->
        </div><!--/modalWrap_error-->

		<script type="text/javascript">

		// 通信先URL　※環境に併せて変更する必要あり！
		const REQUEST_DOMAIN = 'https://paypay-bank--pt49.sandbox.my.salesforce.com';
		let res;
		$(function(){
			//responseApexData();
		});

        let resp;
        // モーダル閉じるボタン(画面遷移なし)
        $(".mClose").on("click", function(){
            var CurrentScrollY = $(window).scrollTop();
            $(".modalOverlay,.modalWrap_error").fadeOut();
            $(".modalWrap_error").css("display", "none");
            $("body").css({position:"",top:0 * CurrentScrollY});
        });
        // 通信失敗
        function dispComErrModal(){
            let CurrentScrollY = $(window).scrollTop();
            $(".modalOverlay,.modalWrap_error.error-comError").fadeIn();
            $(".error-comError").css("display", "block");
            $("body").css({position:"fixed",top:-1 * CurrentScrollY});
        }
        // 時限チェック
        function dispTimeoutErrModal(){
            let CurrentScrollY = $(window).scrollTop();
            $(".modalOverlay,.modalWrap_error.error-timeoutError").fadeIn();
            $(".error-timeoutError").css("display", "block");
            $("body").css({position:"fixed",top:-1 * CurrentScrollY});
        }
        // システムエラー
        function dispAbnormalErrModal(){
            let CurrentScrollY = $(window).scrollTop();
            $(".modalOverlay,.modalWrap_error.error-abnormalError").fadeIn();
            $(".error-abnormalError").css("display", "block");
            $("body").css({position:"fixed",top:-1 * CurrentScrollY});
        }
        // 取引先が存在しない場合(新規問い合わせ登録画面)
        function dispNocaseErrModal(){
            let CurrentScrollY = $(window).scrollTop();
            $(".modalOverlay,.modalWrap_error.error-nocaseError").fadeIn();
            $(".error-nocaseError").css("display", "block");
            $("body").css({position:"fixed",top:-1 * CurrentScrollY});
        }

        function newinq(){
            console.log(res.caseList)
            if(resp.caseList){
                if(resp.caseList.length == 0){
                    dispNocaseErrModal();
                } 
            }
        }

		function responseApexData(){
            $.ajax({
                type: 'POST',
                crossOrigin: true,
                url: REQUEST_DOMAIN + '/services/oauth2/token',
                dataType: 'json',
                cache :false,
                data : {
                    "grant_type":"refresh_token",
                    "client_id":"3MVG99S6MzYiT5k.KkcZzmtcXubr_J8l8N8473VR.oFizQeVyWXFV5ARIiXmwhmXqjuNU.K6Pk9mc9M3btLBQ", 
                    "refresh_token":"5Aep861hjC52juQoBcsFRsbEALR2k2PEkuCJTzezJjsxYDFcfM3Xu_8fN.OBDlZ6BJFv9GwwXc8hH5doNmlIiVu"
                    //"refresh_token":"5Aep861hjC52juQoBcsFRsbEALR2k2PEkuCJTzezJjsxYDFcfM3Xu_8fN.OBDlZ6BJFv9GwwXc8hH5doNm" // アクセス失敗用
                },
                success : function (connectData) {
                    var accToken = 'Bearer ' + connectData.access_token;
                    $.ajax({
                        type: 'GET',
                        crossOrigin: true,
                        url: REQUEST_DOMAIN + '/services/apexrest/IMF_Case',
                        dataType: 'json',
                        cache :false,
                        //data: {inquiry : '789d86fb97fa49352746c2d382ffdec636f460133f7b13b06dad531eab317b0a'}, // timeout
                        //data: {inquiry : '789d86fb97fa49352746c2d382ffdec636f460133f7b13b06dad531eab'}, // abnormal
                        data: {inquiry : '9cd4294277d8d2acc90e86920247ecc18f06d2309fa57662611b3be19c0733f6'}, // nocase
                        headers: {"Authorization" : accToken},
                        success : function (res) {
			                console.log('success');
                            console.log(res);
                            resp = res;
                            if(res.result == 'SUCCESS'){

                            }else if(res.result == 'TIMED_CHECK'){
                                dispTimeoutErrModal();
                            }else{
                                dispAbnormalErrModal();
                            }
                        },
                        error : function (data, errorThrown,status) {
                            console.log('error');
                            dispComErrModal();
                        }
                    })
                },
                error : function (data, errorThrown,status) {
                    console.log('a_error');
                    dispComErrModal();
                }
            });
		}
		</script>
	</body>
</html>
